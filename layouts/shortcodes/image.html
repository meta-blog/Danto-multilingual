{{ $counter := add 1 (index .Page.Params "img_counter" | default 0) }}
{{ .Page.Scratch.Set "img_counter" $counter }}
{{ $image := .Page.Resources.GetMatch (.Get "src") }}
{{ $alt := .Get "alt" | default (printf "%s_%02d" .Page.Title $counter) }}
<figure>
  {{ with $image }}
    {{ $width := .Width }}
    {{ $height := .Height }}
    {{ if gt .Width 800 }}
      {{ $resized := .Resize "800x" }}
      {{ $width = $resized.Width }}
      {{ $height = $resized.Height }}
    {{ end }}
    <img src="{{ .RelPermalink }}" 
         alt="{{ $alt }}"
         width="{{ $width }}" 
         height="{{ $height }}"
         loading="lazy">
  {{ else }}
    <img src="{{ .Get "src" }}" 
         alt="{{ $alt }}"
         loading="lazy">
  {{ end }}
  {{ with .Get "caption" }}
    <figcaption>{{ . }}</figcaption>
  {{ end }}
</figure>